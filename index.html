<!DOCTYPE html>
<html lang="en-GB" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Xurshid's Reading Practice</title>
    <style>
        :root { --primary: #4361ee; --dark-blue: #1a237e; --success: #2ecc71; --error: #e74c3c; --bg: #f4f7fe; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; user-select: none; }
        .author-badge { width: 100%; max-width: 800px; text-align: right; color: var(--dark-blue); font-weight: 700; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .container { background: white; max-width: 800px; width: 100%; padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .main-title { text-align: center; color: var(--primary); margin-bottom: 20px; font-size: 28px; font-weight: 800; }
        .notranslate { 
            font-size: 22px; line-height: 1.8; padding: 30px; background: #fff; border-radius: 16px; margin-bottom: 25px; 
            border: 2px solid #f0f4f8; transition: all 0.3s ease; white-space: pre-wrap; word-wrap: break-word;
        }
        .recording-active { border-color: var(--error); box-shadow: 0 0 20px rgba(231, 76, 60, 0.2); }
        .rec-dot { display: inline-block; width: 12px; height: 12px; background-color: var(--error); border-radius: 50%; margin-right: 8px; animation: blink 1s infinite; display: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .speed-control { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #555; }
        select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; outline: none; cursor: pointer; background: white; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        button { padding: 14px 28px; font-size: 16px; cursor: pointer; border-radius: 12px; border: none; color: white; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-listen { background: #8e9aaf; }
        .btn-start { background: var(--primary); }
        .btn-stop { background: var(--error); display: none; }
        .btn-replay { background: #ff9f1c; display: none; }
        #msg-container { display: flex; align-items: center; justify-content: center; min-height: 30px; margin-bottom: 10px; }
        #msg { font-weight: 600; color: var(--primary); text-align: center; }
        .result-panel { margin-top: 30px; display: none; padding: 30px; border-radius: 20px; background: #fff; border: 2px solid #eef2f6; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; background: var(--bg); border-radius: 12px; border: 1px solid #e0e6ed; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 11px; color: #7f8c8d; text-transform: uppercase; margin-top: 5px; }
        .btn-toggle { background: var(--dark-blue); margin: 0 auto; font-size: 13px; padding: 10px 20px; }
        #analysis-text { 
            display: none; text-align: left; line-height: 2.2; margin-top: 25px; padding: 20px; background: #f9f9f9; 
            border-radius: 12px; border: 1px dashed #ccc; font-size: 20px; white-space: pre-wrap;
        }
        .word-correct { color: var(--success); } 
        .word-error { color: var(--error); text-decoration: underline wavy; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="author-badge">Prepared by Xurshid Jabborov</div>

<div class="container">
    <div class="main-title">Read the text</div>
    <div id="text-area" class="notranslate">Last summer, my family and I went to a small village near the mountains. It was a very beautiful place with fresh air and green trees. Every morning, we woke up early and had a big breakfast. We ate fresh bread, honey, and fruit. After breakfast, we went for long walks. One day, we saw a clear lake and decided to swim. The water was a bit cold, but it was very exciting. In the afternoons, I read my favorite books or talked to the local people. They were very friendly and told us interesting stories about the history of the village. In the evenings, we cooked dinner together over a fire. We stayed there for one week. I felt very happy and relaxed because there was no noise from the city. I want to go back there again next year with my best friends.</div>

    <div class="speed-control">
        <span>Listen Speed:</span>
        <select id="speed-select">
            <option value="0.7">Slow (A1-A2)</option>
            <option value="0.9" selected>Normal (B1-B2)</option>
            <option value="1.2">Fast (C1)</option>
        </select>
    </div>

    <div class="controls">
        <button id="listen-btn" class="btn-listen">üîä Listen</button>
        <button id="start-btn" class="btn-start">üé§ Start Reading</button>
        <button id="stop-btn" class="btn-stop">‚èπ Stop & Check</button>
        <button id="replay-btn" class="btn-replay">üéß Play My Voice</button>
    </div>

    <div id="msg-container">
        <span id="rec-dot" class="rec-dot"></span>
        <p id="msg"></p>
    </div>

    <div id="result-panel" class="result-panel">
        <div id="summary-text" style="margin-bottom:20px; font-size:18px;"></div>
        <div class="stats-grid">
            <div class="stat-card"><div id="score" class="stat-val">0%</div><div class="stat-lbl">Accuracy</div></div>
            <div class="stat-card"><div id="cefr-lvl" class="stat-val">-</div><div class="stat-lbl">CEFR Level</div></div>
            <div class="stat-card"><div id="wpm" class="stat-val">0</div><div class="stat-lbl">WPM Speed</div></div>
        </div>
        <button id="toggle-btn" class="btn-toggle">üîç Show Detailed Analysis</button>
        <div id="analysis-text" class="notranslate"></div>
    </div>
</div>

<script>
    const listenBtn = document.getElementById('listen-btn'),
          startBtn = document.getElementById('start-btn'),
          stopBtn = document.getElementById('stop-btn'),
          replayBtn = document.getElementById('replay-btn'),
          resultPanel = document.getElementById('result-panel'),
          analysisText = document.getElementById('analysis-text'),
          summaryText = document.getElementById('summary-text'),
          toggleBtn = document.getElementById('toggle-btn'),
          scoreDisplay = document.getElementById('score'),
          cefrDisplay = document.getElementById('cefr-lvl'),
          wpmDisplay = document.getElementById('wpm'),
          msg = document.getElementById('msg'),
          recDot = document.getElementById('rec-dot'),
          textArea = document.getElementById('text-area'),
          speedSelect = document.getElementById('speed-select');

    let originalText = textArea.innerText.trim();
    let recognition, mediaRecorder, audioChunks = [], audioUrl = null, fullTranscript = "", startTime, stream;

    // Nutqni aniqlash ob'ektini sozlash
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = (event) => {
            let interimText = "";
            let finalResult = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    fullTranscript += event.results[i][0].transcript + " ";
                } else {
                    interimText += event.results[i][0].transcript;
                }
            }
            msg.innerText = "Listening: " + (interimText || "...");
        };

        recognition.onerror = (e) => {
            console.error("Speech Recognition Error:", e.error);
        };
    }

    listenBtn.onclick = () => {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(textArea.innerText);
        utter.rate = parseFloat(speedSelect.value);
        utter.lang = 'en-GB';
        window.speechSynthesis.speak(utter);
    };

    startBtn.onclick = async () => {
        try {
            // Birinchi mikrofon oqimini olamiz
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // O'zgaruvchilarni tozalaymiz
            fullTranscript = "";
            audioChunks = [];
            resultPanel.style.display = "none";
            replayBtn.style.display = "none";

            // Nutqni aniqlashni boshlash (Telefonda birinchi shu bo'lishi kerak)
            if (recognition) recognition.start();

            // MediaRecorder sozlash
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                audioUrl = URL.createObjectURL(new Blob(audioChunks, { type: 'audio/wav' }));
                replayBtn.style.display = "flex";
            };
            mediaRecorder.start();

            startTime = Date.now();
            startBtn.style.display = "none";
            stopBtn.style.display = "flex";
            recDot.style.display = "inline-block";
            textArea.classList.add('recording-active');
            msg.innerText = "Speak now...";
        } catch (err) {
            alert("Error: Microphone access denied or not supported on this browser.");
        }
    };

    stopBtn.onclick = () => {
        if (recognition) recognition.stop();
        if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        
        const duration = (Date.now() - startTime) / 60000;
        
        stopBtn.style.display = "none";
        startBtn.style.display = "flex";
        recDot.style.display = "none";
        textArea.classList.remove('recording-active');
        msg.innerText = "Processing analysis...";

        // Telefonda nutqni oxirigacha yig'ib olish uchun 1 soniya kutamiz
        setTimeout(() => {
            calculateResults(duration);
            if (stream) stream.getTracks().forEach(track => track.stop());
        }, 1000);
    };

    function calculateResults(duration) {
        const cleanUser = fullTranscript.toLowerCase().replace(/[.,!?;]/g, "").split(/\s+/).filter(w => w.length > 0);
        const numbersMap = { "1": "one", "2": "two", "3": "three", "4": "four", "5": "five", "6": "six", "7": "seven", "8": "eight", "9": "nine", "10": "ten" };
        
        // Homofonlar va o'xshash so'zlar ro'yxati (Original kodingizdagi mantiq)
        function isSimilar(s1, s2) {
            if (!s1 || !s2) return false;
            let w1 = s1.toLowerCase().replace(/[.,!?;]/g, "").trim();
            let w2 = s2.toLowerCase().replace(/[.,!?;]/g, "").trim();
            if (w1 === w2) return true;
            if (numbersMap[w1] === w2 || numbersMap[w2] === w1) return true;

            const homophones = {
                "were": ["where", "we're", "wear", "war", "was", "are"],
                "felt": ["fell", "feel", "fill", "filled", "belt"],
                "very": ["every", "vary", "really", "berry"],
                "their": ["there", "they're"],
                "too": ["to", "two"],
                "your": ["you're"],
                "it's": ["its"],
                "talked": ["talk", "told"],
                "cooked": ["cook", "look"]
            };

            if (homophones[w1] && homophones[w1].includes(w2)) return true;
            if (homophones[w2] && homophones[w2].includes(w1)) return true;
            if (w1.endsWith('ed') && w1.slice(0, -2) === w2) return true;
            if (w2.endsWith('ed') && w2.slice(0, -2) === w1) return true;
            if (w1.endsWith('s') && w1.slice(0, -1) === w2) return true;
            if (w2.endsWith('s') && w2.slice(0, -1) === w1) return true;

            let longer = w1.length > w2.length ? w1 : w2;
            let shorter = w1.length > w2.length ? w2 : w1;
            let diff = 0;
            for (let i = 0; i < shorter.length; i++) {
                if (longer[i] !== shorter[i]) diff++;
            }
            diff += (longer.length - shorter.length);
            if (longer.length <= 3) return diff <= 1;
            if (longer.length <= 6) return diff <= 2;
            return (longer.length - diff) / longer.length > 0.5;
        }

        const wordsInOrig = originalText.split(/(\s+)/);
        let finalHtml = "";
        let correct = 0;
        let totalWords = 0;

        wordsInOrig.forEach(part => {
            if (/\s+/.test(part)) {
                finalHtml += part;
            } else {
                totalWords++;
                let cleanPart = part.toLowerCase().replace(/[.,!?;]/g, "");
                let foundIndex = -1;
                for (let i = 0; i < cleanUser.length; i++) {
                    if (isSimilar(cleanPart, cleanUser[i])) {
                        foundIndex = i;
                        break;
                    }
                }
                if (foundIndex !== -1) {
                    correct++;
                    finalHtml += `<span class="word-correct">${part}</span>`;
                    cleanUser.splice(foundIndex, 1);
                } else {
                    finalHtml += `<span class="word-error">${part}</span>`;
                }
            }
        });

        const accuracy = Math.min(100, Math.round((correct / totalWords) * 100));
        const userWordCount = fullTranscript.trim().split(/\s+/).filter(w => w.length > 0).length;
        const wpm = Math.round(userWordCount / duration) || 0;

        let level = "A1";
        if (accuracy >= 90 && wpm >= 120) level = "C1 (Advanced)";
        else if (accuracy >= 80 && wpm >= 90) level = "B2 (Upper-Int)";
        else if (accuracy >= 65 && wpm >= 60) level = "B1 (Intermediate)";
        else if (accuracy >= 45 && wpm >= 35) level = "A2 (Pre-Int)";
        else level = "A1 (Beginner)";

        scoreDisplay.innerText = accuracy + "%";
        wpmDisplay.innerText = wpm;
        cefrDisplay.innerText = level;
        analysisText.innerHTML = finalHtml;
        resultPanel.style.display = "block";
        summaryText.innerText = accuracy > 0 ? "Good job! Review your analysis below." : "Voice not recognized clearly. Please try again.";
        msg.innerText = "Analysis Ready!";
    }

    replayBtn.onclick = () => { if (audioUrl) new Audio(audioUrl).play(); };
    toggleBtn.onclick = () => {
        const show = analysisText.style.display === "none" || analysisText.style.display === "";
        analysisText.style.display = show ? "block" : "none";
        toggleBtn.innerText = show ? "‚ñ≤ Hide Details" : "üîç Show Detailed Analysis";
    };
</script>
</body>
</html>
