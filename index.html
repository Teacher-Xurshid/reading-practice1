<!DOCTYPE html>
<html lang="en-GB" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xurshid's Reading Practice</title>
    <style>
        :root { --p: #4361ee; --s: #2ecc71; --e: #e74c3c; --bg: #f4f7fe; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; max-width: 800px; width: 100%; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .notranslate { font-size: 20px; line-height: 1.6; padding: 20px; border: 2px solid #eee; border-radius: 15px; margin-bottom: 20px; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 20px; border-radius: 10px; border: none; color: white; font-weight: 600; cursor: pointer; }
        .btn-start { background: var(--p); }
        .btn-stop { background: var(--e); display: none; }
        .btn-replay { background: #ff9f1c; display: none; }
        .result-panel { display: none; margin-top: 20px; text-align: center; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-card { background: var(--bg); padding: 10px; border-radius: 10px; }
        .word-correct { color: var(--s); }
        .word-error { color: var(--e); text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:var(--p)">Read the text</h2>
    <div id="text-area" class="notranslate">Last summer, my family and I went to a small village near the mountains. It was a very beautiful place with fresh air and green trees. Every morning, we woke up early and had a big breakfast. We ate fresh bread, honey, and fruit. After breakfast, we went for long walks. One day, we saw a clear lake and decided to swim. The water was a bit cold, but it was very exciting. In the afternoons, I read my favorite books or talked to the local people. They were very friendly and told us interesting stories about the history of the village. In the evenings, we cooked dinner together over a fire. We stayed there for one week. I felt very happy and relaxed because there was no noise from the city. I want to go back there again next year with my best friends.</div>

    <div class="controls">
        <button id="start-btn" class="btn-start">üé§ Start Reading</button>
        <button id="stop-btn" class="btn-stop">‚èπ Stop & Analyze</button>
        <button id="replay-btn" class="btn-replay">üéß Play My Voice</button>
    </div>

    <p id="status" style="text-align:center; font-weight:bold; color:var(--p)"></p>

    <div id="result-panel" class="result-panel">
        <div class="stats">
            <div class="stat-card"><h3>Accuracy</h3><div id="score" style="font-size:24px; color:var(--p)">0%</div></div>
            <div class="stat-card"><h3>WPM</h3><div id="wpm" style="font-size:24px; color:var(--p)">0</div></div>
        </div>
        <div id="analysis-text" class="notranslate" style="margin-top:20px; text-align:left; display:none"></div>
        <button id="show-btn" style="background:#1a237e; margin-top:10px">üîç Show Details</button>
    </div>
</div>

<script>
    const startBtn = document.getElementById('start-btn'),
          stopBtn = document.getElementById('stop-btn'),
          replayBtn = document.getElementById('replay-btn'),
          status = document.getElementById('status'),
          scoreDisp = document.getElementById('score'),
          wpmDisp = document.getElementById('wpm'),
          analysisText = document.getElementById('analysis-text'),
          resultPanel = document.getElementById('result-panel');

    let recognition, mediaRecorder, audioChunks = [], audioUrl = null, fullTranscript = "", startTime;
    const originalText = document.getElementById('text-area').innerText.trim();

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        recognition.onresult = (e) => {
            let txt = "";
            for (let i = 0; i < e.results.length; i++) txt += e.results[i][0].transcript + " ";
            fullTranscript = txt;
        };
    }

    startBtn.onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = []; fullTranscript = "";
            resultPanel.style.display = "none";
            analysisText.style.display = "none";

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                audioUrl = URL.createObjectURL(new Blob(audioChunks, { type: 'audio/wav' }));
                replayBtn.style.display = "inline-block";
            };

            mediaRecorder.start();
            recognition.start();
            
            startTime = Date.now();
            startBtn.style.display = "none";
            stopBtn.style.display = "inline-block";
            status.innerText = "Recording and Analyzing...";
        } catch (e) { alert("Mic error. Use HTTPS."); }
    };

    stopBtn.onclick = () => {
        recognition.stop();
        mediaRecorder.stop();
        const duration = (Date.now() - startTime) / 60000;
        
        stopBtn.style.display = "none";
        startBtn.style.display = "inline-block";
        status.innerText = "Processing results...";

        setTimeout(() => {
            if (!fullTranscript.trim()) {
                status.innerText = "Error: No speech detected. Please try again in Chrome/Safari.";
            } else {
                calculate(duration);
                status.innerText = "Done!";
            }
        }, 1500);
    };

    function calculate(duration) {
        const userWords = fullTranscript.toLowerCase().match(/\b(\w+)\b/g) || [];
        const origWords = originalText.split(/(\s+)/);
        let html = "", correct = 0, total = 0;

        origWords.forEach(word => {
            if (/\s+/.test(word)) html += word;
            else {
                total++;
                let clean = word.toLowerCase().replace(/[.,!?;]/g, "");
                let idx = userWords.indexOf(clean);
                if (idx !== -1) {
                    correct++;
                    html += `<span class="word-correct">${word}</span>`;
                    userWords.splice(idx, 1);
                } else {
                    html += `<span class="word-error">${word}</span>`;
                }
            }
        });

        scoreDisp.innerText = Math.round((correct / total) * 100) + "%";
        wpmDisp.innerText = Math.round(total / duration) || 0;
        analysisText.innerHTML = html;
        resultPanel.style.display = "block";
    }

    document.getElementById('show-btn').onclick = () => analysisText.style.display = "block";
    replayBtn.onclick = () => { if(audioUrl) new Audio(audioUrl).play(); };
</script>
</body>
</html>
